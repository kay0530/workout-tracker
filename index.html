<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Á≠ã„Éà„É¨Ë®òÈå≤">
  <meta name="theme-color" content="#0d0d14">
  <title>Á≠ã„Éà„É¨Ë®òÈå≤</title>
  <link rel="apple-touch-icon" href="icon-192.svg">
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      background: #0d0d14;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overflow-x: hidden;
    }
    button { font-family: inherit; cursor: pointer; border: none; }
    input, textarea { font-family: inherit; }

    .header { padding: 20px 20px 0; background: linear-gradient(180deg, rgba(255,107,53,0.08) 0%, transparent 100%); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .app-title { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, #ff6b35, #ff9f6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .streak-badge { background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.3); border-radius: 20px; padding: 4px 12px; font-size: 13px; font-weight: 700; color: #ff6b35; }
    .backup-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; width: 36px; height: 36px; font-size: 16px; display: flex; align-items: center; justify-content: center; color: #aaa; }

    .tabs { display: flex; }
    .tab { flex: 1; background: none; color: #666; font-size: 13px; font-weight: 600; padding: 12px 0; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab.active { color: #ff6b35; border-bottom-color: #ff6b35; }

    .content { padding: 16px 20px 40px; }

    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; }
    .card.done { background: rgba(0,230,118,0.04); border-color: rgba(0,230,118,0.2); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .check-mark { width: 28px; height: 28px; border-radius: 50%; background: #00e676; color: #0d0d14; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; }

    .date-nav { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
    .date-btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #aaa; width: 36px; height: 36px; border-radius: 10px; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .date-text { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; margin: 0 16px; }
    .today-label { font-size: 10px; font-weight: 800; color: #ff6b35; background: rgba(255,107,53,0.15); padding: 2px 6px; border-radius: 4px; letter-spacing: 1px; margin-left: 8px; }

    .action-btn { width: 100%; padding: 12px; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 700; }
    .edit-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); color: #aaa; padding: 6px 14px; border-radius: 8px; font-size: 12px; }
    .delete-btn { background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.2); color: #ff5050; padding: 6px 14px; border-radius: 8px; font-size: 12px; }
    .edit-btn-sm { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); color: #aaa; padding: 4px 10px; border-radius: 6px; font-size: 11px; }
    .delete-btn-sm { background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.2); color: #ff5050; padding: 4px 10px; border-radius: 6px; font-size: 11px; }

    .num-input { flex: 1; padding: 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 16px; outline: none; }
    .submit-btn { padding: 10px 20px; background: #ff6b35; border-radius: 10px; color: #fff; font-size: 14px; font-weight: 700; white-space: nowrap; }
    .cancel-link { background: none; color: #666; font-size: 13px; padding: 4px 0; }
    .add-more-btn { flex: 1; padding: 8px; background: transparent; border: 1px dashed; border-radius: 8px; font-size: 12px; font-weight: 600; }

    .chip-btn { padding: 8px 14px; border-radius: 10px; border: 1px solid; font-size: 13px; font-weight: 600; background: none; transition: all 0.2s; }
    .period-bar { display: flex; background: rgba(255,255,255,0.04); border-radius: 10px; padding: 3px; margin-bottom: 20px; }
    .period-btn { flex: 1; padding: 8px 0; border-radius: 8px; font-size: 13px; font-weight: 600; background: transparent; color: #888; transition: all 0.2s; }
    .period-btn.active { color: #fff; }

    .stat-box { text-align: center; }
    .stat-box .label { font-size: 11px; color: #888; margin-bottom: 4px; }
    .stat-box .value { font-size: 16px; font-weight: 800; }

    .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #2a2a3e; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 10px 20px; font-size: 13px; font-weight: 600; z-index: 999; box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none; }
    .toast.show { display: block; }

    .warning-box { background: rgba(255,160,0,0.1); border: 1px solid rgba(255,160,0,0.3); border-radius: 8px; padding: 8px 12px; margin-bottom: 12px; font-size: 11px; color: #ffa000; line-height: 1.5; }

    .history-item { cursor: pointer; }
    .history-item .complete-badge { font-size: 10px; font-weight: 800; color: #00e676; background: rgba(0,230,118,0.12); padding: 3px 8px; border-radius: 6px; letter-spacing: 1px; }

    .backup-panel { padding: 16px 20px; }
    .backup-panel textarea { width: 100%; min-height: 80px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 12px; padding: 10px; font-family: monospace; outline: none; resize: vertical; box-sizing: border-box; }

    .chart-canvas { width: 100%; height: 220px; display: block; }

    .week-dots { display: flex; justify-content: space-around; }
    .week-dot { width: 10px; height: 10px; border-radius: 50%; }

    .flex-row { display: flex; }
    .flex-col { display: flex; flex-direction: column; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .gap-4 { gap: 4px; } .gap-6 { gap: 6px; } .gap-8 { gap: 8px; } .gap-10 { gap: 10px; } .gap-12 { gap: 12px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast" class="toast"></div>

  <script>
    "use strict";

    // ---- Data & Constants ----
    var EXERCISES = [
      { id: "ab_hiza",  name: "ËÜù„Ç≥„É≠",     icon: "\uD83D\uDD04", type: "reps", unit: "Âõû", color: "#ff6b35", group: "abroller" },
      { id: "ab_tachi", name: "Á´ã„Å°„Ç≥„É≠",    icon: "\uD83D\uDD04", type: "reps", unit: "Âõû", color: "#ff9f6b", group: "abroller" },
      { id: "plank",    name: "„Éó„É©„É≥„ÇØ",    icon: "\uD83E\uDDD8", type: "time", unit: "Áßí", color: "#00e676" },
      { id: "pullup",   name: "Êá∏ÂûÇ",       icon: "\uD83D\uDCAA", type: "reps", unit: "Âõû", color: "#448aff" },
      { id: "squat",    name: "„Çπ„ÇØ„ÉØ„ÉÉ„Éà",  icon: "\uD83E\uDDB5", type: "time", unit: "Áßí", color: "#e040fb" }
    ];

    var EXERCISE_GROUPS = [
      { groupId: "abroller", label: "„Ç¢„Éñ„É≠„Éº„É©„Éº", icon: "\uD83D\uDD04", color: "#ff6b35", members: ["ab_hiza", "ab_tachi"] },
      { groupId: "plank",    label: "„Éó„É©„É≥„ÇØ",     icon: "\uD83E\uDDD8", color: "#00e676", members: ["plank"] },
      { groupId: "pullup",   label: "Êá∏ÂûÇ",        icon: "\uD83D\uDCAA", color: "#448aff", members: ["pullup"] },
      { groupId: "squat",    label: "„Çπ„ÇØ„ÉØ„ÉÉ„Éà",   icon: "\uD83E\uDDB5", color: "#e040fb", members: ["squat"] }
    ];

    var TOTAL_GROUPS = EXERCISE_GROUPS.length;
    var STORAGE_KEY = "workout-log-v3";
    var DAYS_JP = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];

    // ---- State ----
    var state = {
      records: {},
      selectedDate: new Date(),
      view: "today",
      timerActive: false,
      timerSeconds: 0,
      timerExId: null,
      editingExercise: null,
      inputValue: "",
      chartExercise: "ab_hiza",
      chartPeriod: "week",
      showBackup: false,
      importText: "",
      storageOk: false,
      loaded: false
    };
    var timerInterval = null;

    // ---- Helpers ----
    function formatDate(d) {
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
    }
    function formatDateJP(d) {
      return (d.getMonth()+1) + "/" + d.getDate() + "(" + DAYS_JP[d.getDay()] + ")";
    }
    function formatTime(sec) {
      if (!sec) return "\u2014";
      var m = Math.floor(sec/60), s = sec % 60;
      return m > 0 ? m + "ÂàÜ" + (s > 0 ? s + "Áßí" : "") : s + "Áßí";
    }
    function parseLocalDate(str) {
      var p = str.split("-").map(Number);
      return new Date(p[0], p[1]-1, p[2]);
    }
    function findEx(id) {
      for (var i = 0; i < EXERCISES.length; i++) { if (EXERCISES[i].id === id) return EXERCISES[i]; }
      return null;
    }
    function countCompletedGroups(dayRec) {
      if (!dayRec) return 0;
      var count = 0;
      for (var i = 0; i < EXERCISE_GROUPS.length; i++) {
        var g = EXERCISE_GROUPS[i];
        for (var j = 0; j < g.members.length; j++) {
          if (dayRec[g.members[j]] != null) { count++; break; }
        }
      }
      return count;
    }
    function el(tag, attrs, children) {
      var e = document.createElement(tag);
      if (attrs) {
        for (var k in attrs) {
          if (k === "className") e.className = attrs[k];
          else if (k === "style" && typeof attrs[k] === "object") {
            for (var sk in attrs[k]) e.style[sk] = attrs[k][sk];
          }
          else if (k.indexOf("on") === 0) e.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
          else if (k === "value") e.value = attrs[k];
          else if (k === "placeholder") e.placeholder = attrs[k];
          else if (k === "type") e.type = attrs[k];
          else if (k === "autofocus") e.setAttribute("autofocus", "");
          else e.setAttribute(k, attrs[k]);
        }
      }
      if (children != null) {
        if (typeof children === "string" || typeof children === "number") e.textContent = String(children);
        else if (Array.isArray(children)) {
          for (var i = 0; i < children.length; i++) {
            if (children[i] != null && children[i] !== false) {
              if (typeof children[i] === "string" || typeof children[i] === "number") e.appendChild(document.createTextNode(String(children[i])));
              else e.appendChild(children[i]);
            }
          }
        }
        else if (children.nodeType) e.appendChild(children);
      }
      return e;
    }
    function txt(s) { return document.createTextNode(s); }

    // ---- Storage ----
    function storageGet(key) {
      try { var v = localStorage.getItem(key); return v !== null ? v : null; } catch(e) { return null; }
    }
    function storageSet(key, val) {
      try { localStorage.setItem(key, val); return true; } catch(e) { return false; }
    }
    function storageDel(key) {
      try { localStorage.removeItem(key); return true; } catch(e) { return false; }
    }

    function loadRecords() {
      var raw = storageGet(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
      var oldKeys = ["workout-log-v2", "workout-log-v1"];
      for (var i = 0; i < oldKeys.length; i++) {
        var old = storageGet(oldKeys[i]);
        if (old) {
          var parsed = JSON.parse(old);
          var migrated = {};
          var keys = Object.keys(parsed);
          for (var j = 0; j < keys.length; j++) {
            var day = {};
            for (var dk in parsed[keys[j]]) day[dk] = parsed[keys[j]][dk];
            if (day.abroller != null && day.ab_hiza == null) { day.ab_hiza = day.abroller; delete day.abroller; }
            migrated[keys[j]] = day;
          }
          return migrated;
        }
      }
      return {};
    }
    function saveRecords(data) { storageSet(STORAGE_KEY, JSON.stringify(data)); }

    // ---- Toast ----
    function showToast(msg) {
      var t = document.getElementById("toast");
      t.textContent = msg;
      t.className = "toast show";
      setTimeout(function() { t.className = "toast"; }, 2500);
    }

    // ---- Timer ----
    function startTimer(exId) {
      state.timerActive = true;
      state.timerSeconds = 0;
      state.timerExId = exId;
      timerInterval = setInterval(function() {
        state.timerSeconds++;
        render();
      }, 1000);
    }
    function stopTimer() {
      state.timerActive = false;
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      var sec = state.timerSeconds;
      var exId = state.timerExId;
      state.timerSeconds = 0;
      state.timerExId = null;
      return { exId: exId, seconds: sec };
    }

    // ---- Actions ----
    function saveRecord(exId, val) {
      var key = formatDate(state.selectedDate);
      if (!state.records[key]) state.records[key] = {};
      state.records[key][exId] = val;
      saveRecords(state.records);
      render();
    }
    function deleteRecord(exId) {
      var key = formatDate(state.selectedDate);
      if (!state.records[key]) return;
      delete state.records[key][exId];
      if (Object.keys(state.records[key]).length === 0) delete state.records[key];
      saveRecords(state.records);
      render();
    }
    function handleTimerToggle(exId) {
      if (state.timerActive && state.timerExId === exId) {
        var result = stopTimer();
        saveRecord(result.exId, result.seconds);
        state.editingExercise = null;
      } else {
        if (state.timerActive) stopTimer();
        startTimer(exId);
      }
      render();
    }
    function handleInputSubmit(exId) {
      var val = parseInt(state.inputValue, 10);
      if (!isNaN(val) && val > 0) saveRecord(exId, val);
      state.editingExercise = null;
      state.inputValue = "";
      render();
    }
    function cancelEditing() {
      if (state.timerActive) stopTimer();
      state.editingExercise = null;
      state.inputValue = "";
      render();
    }

    // ---- Chart (Canvas) ----
    function drawBarChart(canvas, data, color) {
      var ctx = canvas.getContext("2d");
      var dpr = window.devicePixelRatio || 1;
      var w = canvas.clientWidth;
      var h = canvas.clientHeight;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, w, h);

      var maxVal = 0;
      for (var i = 0; i < data.length; i++) { if (data[i].value > maxVal) maxVal = data[i].value; }
      if (maxVal === 0) maxVal = 1;

      var padL = 40, padR = 10, padT = 10, padB = 30;
      var chartW = w - padL - padR;
      var chartH = h - padT - padB;
      var barW = Math.min(chartW / data.length * 0.6, 32);
      var gap = chartW / data.length;

      // Grid lines
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.lineWidth = 1;
      for (var gi = 0; gi <= 4; gi++) {
        var gy = padT + chartH - (chartH * gi / 4);
        ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(w - padR, gy); ctx.stroke();
        ctx.fillStyle = "#666";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(String(Math.round(maxVal * gi / 4)), padL - 6, gy + 3);
      }

      // Bars
      for (var i = 0; i < data.length; i++) {
        var bh = (data[i].value / maxVal) * chartH;
        var bx = padL + gap * i + (gap - barW) / 2;
        var by = padT + chartH - bh;

        ctx.fillStyle = color;
        ctx.beginPath();
        if (bh > 6) {
          var r = 4;
          ctx.moveTo(bx + r, by);
          ctx.lineTo(bx + barW - r, by);
          ctx.quadraticCurveTo(bx + barW, by, bx + barW, by + r);
          ctx.lineTo(bx + barW, padT + chartH);
          ctx.lineTo(bx, padT + chartH);
          ctx.lineTo(bx, by + r);
          ctx.quadraticCurveTo(bx, by, bx + r, by);
        } else if (bh > 0) {
          ctx.rect(bx, by, barW, bh);
        }
        ctx.fill();

        // Label
        ctx.fillStyle = "#888";
        ctx.font = "11px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(data[i].label, padL + gap * i + gap / 2, h - 8);
      }
    }

    function drawLineChart(canvas, data, color) {
      var ctx = canvas.getContext("2d");
      var dpr = window.devicePixelRatio || 1;
      var w = canvas.clientWidth;
      var h = canvas.clientHeight;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, w, h);

      var maxVal = 0;
      for (var i = 0; i < data.length; i++) { if (data[i].value > maxVal) maxVal = data[i].value; }
      if (maxVal === 0) maxVal = 1;

      var padL = 40, padR = 10, padT = 10, padB = 30;
      var chartW = w - padL - padR;
      var chartH = h - padT - padB;
      var gap = chartW / (data.length - 1 || 1);

      // Grid lines
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.lineWidth = 1;
      for (var gi = 0; gi <= 4; gi++) {
        var gy = padT + chartH - (chartH * gi / 4);
        ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(w - padR, gy); ctx.stroke();
        ctx.fillStyle = "#666";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(String(Math.round(maxVal * gi / 4)), padL - 6, gy + 3);
      }

      // Line
      ctx.strokeStyle = color;
      ctx.lineWidth = 2.5;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.beginPath();
      for (var i = 0; i < data.length; i++) {
        var x = padL + gap * i;
        var y = padT + chartH - (data[i].value / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Dots
      for (var i = 0; i < data.length; i++) {
        var x = padL + gap * i;
        var y = padT + chartH - (data[i].value / maxVal) * chartH;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
      }

      // Labels (show every 5th for month)
      for (var i = 0; i < data.length; i++) {
        if (data.length > 10 && i % 5 !== 0 && i !== data.length - 1) continue;
        ctx.fillStyle = "#888";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(data[i].label, padL + gap * i, h - 8);
      }
    }

    function getChartData(exerciseId, period) {
      var records = state.records;
      var today = new Date();
      var dates = [];
      var i;
      if (period === "week") {
        for (i = 6; i >= 0; i--) { var d = new Date(today); d.setDate(d.getDate() - i); dates.push(d); }
      } else if (period === "month") {
        for (i = 29; i >= 0; i--) { var d = new Date(today); d.setDate(d.getDate() - i); dates.push(d); }
      } else {
        for (i = 11; i >= 0; i--) { var d = new Date(today); d.setMonth(d.getMonth() - i); dates.push(d); }
      }

      if (period === "year") {
        return dates.map(function(d) {
          var y = d.getFullYear(), m = d.getMonth();
          var sum = 0, count = 0;
          var keys = Object.keys(records);
          for (var j = 0; j < keys.length; j++) {
            var rd = parseLocalDate(keys[j]);
            if (rd.getFullYear() === y && rd.getMonth() === m && records[keys[j]][exerciseId] != null) {
              sum += records[keys[j]][exerciseId]; count++;
            }
          }
          return { label: (m+1) + "Êúà", value: count > 0 ? Math.round(sum/count) : 0 };
        });
      }
      return dates.map(function(d) {
        var key = formatDate(d);
        var val = records[key] ? records[key][exerciseId] : undefined;
        return {
          label: period === "week" ? DAYS_JP[d.getDay()] : ((d.getMonth()+1) + "/" + d.getDate()),
          value: val != null ? val : 0
        };
      });
    }

    // ---- Streak & Week ----
    function calcStreak() {
      var s = 0, d = new Date();
      while (true) {
        var k = formatDate(d);
        if (countCompletedGroups(state.records[k]) === TOTAL_GROUPS) { s++; d.setDate(d.getDate()-1); }
        else break;
      }
      return s;
    }
    function getWeekData() {
      var data = [];
      for (var i = 6; i >= 0; i--) {
        var d = new Date(); d.setDate(d.getDate() - i);
        var k = formatDate(d);
        var dayRec = state.records[k] || {};
        var groupDone = [];
        for (var gi = 0; gi < EXERCISE_GROUPS.length; gi++) {
          var g = EXERCISE_GROUPS[gi];
          var done = false;
          for (var mi = 0; mi < g.members.length; mi++) {
            if (dayRec[g.members[mi]] != null) { done = true; break; }
          }
          groupDone.push(done);
        }
        data.push({ date: d, completed: countCompletedGroups(dayRec), groupDone: groupDone });
      }
      return data;
    }

    // ---- RENDER ----
    function render() {
      var app = document.getElementById("app");
      app.innerHTML = "";

      var todayKey = formatDate(state.selectedDate);
      var todayRecords = state.records[todayKey] || {};
      var isToday = formatDate(state.selectedDate) === formatDate(new Date());
      var completedGroups = countCompletedGroups(todayRecords);
      var streak = calcStreak();

      // Header
      var header = el("div", { className: "header" });
      var headerTop = el("div", { className: "header-top" });
      headerTop.appendChild(el("h1", { className: "app-title" }, "Á≠ã„Éà„É¨Ë®òÈå≤"));

      var headerRight = el("div", { style: { display: "flex", alignItems: "center", gap: "8px" } });
      if (streak > 0) {
        headerRight.appendChild(el("div", { className: "streak-badge" }, "\uD83D\uDD25 " + streak + "Êó•ÈÄ£Á∂ö"));
      }
      var backupBtn = el("button", { className: "backup-btn", onClick: function() { state.showBackup = !state.showBackup; render(); } }, "\uD83D\uDCBE");
      headerRight.appendChild(backupBtn);
      headerTop.appendChild(headerRight);
      header.appendChild(headerTop);

      // Storage warning
      if (!state.storageOk && state.loaded) {
        header.appendChild(el("div", { className: "warning-box" }, "‚ö†Ô∏è Ëá™Âãï‰øùÂ≠ò„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇüíæ„Éú„Çø„É≥„Åã„Çâ„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"));
      }

      // Tabs
      var tabs = el("div", { className: "tabs" });
      var tabData = [["today","‰ªäÊó•„ÅÆË®òÈå≤"],["chart","„Ç∞„É©„Éï"],["history","Â±•Ê≠¥"]];
      for (var ti = 0; ti < tabData.length; ti++) {
        (function(key, label) {
          var tabBtn = el("button", {
            className: "tab" + (state.view === key ? " active" : ""),
            onClick: function() { state.view = key; if (key === "today") state.selectedDate = new Date(); state.showBackup = false; render(); }
          }, label);
          tabs.appendChild(tabBtn);
        })(tabData[ti][0], tabData[ti][1]);
      }
      header.appendChild(tabs);
      app.appendChild(header);

      // Backup panel
      if (state.showBackup) {
        var bp = el("div", { className: "backup-panel" });
        var bpCard = el("div", { className: "card", style: { padding: "16px" } });
        bpCard.appendChild(el("div", { style: { fontSize: "15px", fontWeight: "700", marginBottom: "12px" } }, "\uD83D\uDCBE „Éá„Éº„ÇøÁÆ°ÁêÜ"));
        bpCard.appendChild(el("div", { style: { fontSize: "12px", color: "#888", marginBottom: "16px", lineHeight: "1.5" } },
          state.storageOk ? "‚úÖ Ëá™Âãï‰øùÂ≠ò„ÅØÊúâÂäπ„Åß„Åô„ÄÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å®„Åó„Å¶„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ" : "‚ö†Ô∏è Ëá™Âãï‰øùÂ≠ò„ÅåÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç¢„Éó„É™„ÇíÈñâ„Åò„ÇãÂâç„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"));

        var exportBtn = el("button", {
          className: "action-btn",
          style: { background: "linear-gradient(135deg,#448aff,#448affaa)", marginBottom: "16px" },
          onClick: function() {
            var json = JSON.stringify(state.records, null, 2);
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(json).then(function() { showToast("‚úÖ „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"); }).catch(function() { showToast("„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); });
            } else { showToast("„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); }
          }
        }, "\uD83D\uDCCB „Éá„Éº„Çø„Çí„Ç≥„Éî„ÉºÔºà„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºâ");
        bpCard.appendChild(exportBtn);

        bpCard.appendChild(el("div", { style: { fontSize: "11px", color: "#666", marginBottom: "16px", textAlign: "center" } }, "Ë®òÈå≤Êï∞: " + Object.keys(state.records).length + "Êó•ÂàÜ"));
        bpCard.appendChild(el("div", { style: { fontSize: "13px", fontWeight: "600", marginBottom: "8px", color: "#aaa" } }, "„Éá„Éº„ÇøÂæ©ÂÖÉÔºà„Ç§„É≥„Éù„Éº„ÉàÔºâ"));

        var ta = el("textarea", { placeholder: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„ÅüJSON„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë...", value: state.importText, onInput: function(e) { state.importText = e.target.value; } });
        bpCard.appendChild(ta);

        var importBtn = el("button", {
          className: "action-btn",
          style: { background: "linear-gradient(135deg,#00e676,#00e676aa)", marginTop: "8px" },
          onClick: function() {
            try {
              var data = JSON.parse(state.importText.trim());
              if (typeof data !== "object" || Array.isArray(data)) throw new Error("invalid");
              for (var k in data) { if (!state.records[k]) state.records[k] = {}; for (var dk in data[k]) state.records[k][dk] = data[k][dk]; }
              saveRecords(state.records);
              state.importText = "";
              state.showBackup = false;
              showToast("‚úÖ „Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü");
              render();
            } catch(e) { showToast("‚ùå JSON„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì"); }
          }
        }, "\uD83D\uDCE5 Âæ©ÂÖÉ„Åô„Çã");
        bpCard.appendChild(importBtn);
        bp.appendChild(bpCard);
        app.appendChild(bp);
      }

      var content = el("div", { className: "content" });

      // ===== TODAY VIEW =====
      if (state.view === "today") {
        // Date navigation
        var dateNav = el("div", { className: "date-nav" });
        dateNav.appendChild(el("button", { className: "date-btn", onClick: function() { state.selectedDate.setDate(state.selectedDate.getDate()-1); render(); } }, "\u25C0"));
        var dateCenter = el("span", { className: "date-text" }, formatDateJP(state.selectedDate));
        dateNav.appendChild(dateCenter);
        if (isToday) dateNav.appendChild(el("span", { className: "today-label" }, "TODAY"));
        dateNav.appendChild(el("button", { className: "date-btn", onClick: function() { var nd = new Date(state.selectedDate); nd.setDate(nd.getDate()+1); if (nd <= new Date()) { state.selectedDate = nd; render(); } } }, "\u25B6"));
        content.appendChild(dateNav);

        // Progress ring (SVG)
        var ringDiv = el("div", { style: { display: "flex", justifyContent: "center", marginBottom: "24px" } });
        var ringInner = el("div", { style: { position: "relative", width: "100px", height: "100px" } });
        var svgNS = "http://www.w3.org/2000/svg";
        var svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100"); svg.setAttribute("height", "100"); svg.setAttribute("viewBox", "0 0 100 100");
        var bgCircle = document.createElementNS(svgNS, "circle");
        bgCircle.setAttribute("cx","50"); bgCircle.setAttribute("cy","50"); bgCircle.setAttribute("r","42");
        bgCircle.setAttribute("fill","none"); bgCircle.setAttribute("stroke","#2a2a3a"); bgCircle.setAttribute("stroke-width","8");
        svg.appendChild(bgCircle);
        var fgCircle = document.createElementNS(svgNS, "circle");
        fgCircle.setAttribute("cx","50"); fgCircle.setAttribute("cy","50"); fgCircle.setAttribute("r","42");
        fgCircle.setAttribute("fill","none");
        fgCircle.setAttribute("stroke", completedGroups === TOTAL_GROUPS ? "#00e676" : "#ff6b35");
        fgCircle.setAttribute("stroke-width","8"); fgCircle.setAttribute("stroke-linecap","round");
        fgCircle.setAttribute("stroke-dasharray", ((completedGroups/TOTAL_GROUPS)*264) + " 264");
        fgCircle.setAttribute("transform","rotate(-90 50 50)");
        fgCircle.style.transition = "stroke-dasharray 0.6s ease";
        svg.appendChild(fgCircle);
        ringInner.appendChild(svg);
        var ringText = el("div", { style: { position: "absolute", top: "50%", left: "50%", transform: "translate(-50%,-50%)", textAlign: "center" } });
        ringText.innerHTML = '<span style="font-size:28px;font-weight:800">' + completedGroups + '</span><span style="font-size:16px;color:#666">/' + TOTAL_GROUPS + '</span>';
        ringInner.appendChild(ringText);
        ringDiv.appendChild(ringInner);
        content.appendChild(ringDiv);

        // Exercise cards
        for (var gi = 0; gi < EXERCISE_GROUPS.length; gi++) {
          (function(group) {
            var members = [];
            for (var mi = 0; mi < group.members.length; mi++) members.push(findEx(group.members[mi]));
            var isMulti = members.length > 1;
            var groupDone = false;
            for (var mi = 0; mi < members.length; mi++) { if (todayRecords[members[mi].id] != null) { groupDone = true; break; } }
            var anyEditing = false;
            for (var mi = 0; mi < members.length; mi++) { if (state.editingExercise === members[mi].id) { anyEditing = true; break; } }

            var card = el("div", { className: "card" + (groupDone ? " done" : "") });

            // Card header
            var ch = el("div", { className: "card-header" });
            var chLeft = el("div", { style: { display: "flex", alignItems: "center", gap: "12px" } });
            chLeft.appendChild(el("span", { style: { fontSize: "28px" } }, group.icon));
            var chInfo = el("div");
            chInfo.appendChild(el("div", { style: { fontSize: "16px", fontWeight: "700" } }, group.label));
            var typeLabel = members[0].type === "time" ? "‚è± ÊôÇÈñìË®òÈå≤" : "üî¢ ÂõûÊï∞Ë®òÈå≤";
            if (isMulti) typeLabel += "  ËÜù„Ç≥„É≠ / Á´ã„Å°„Ç≥„É≠";
            chInfo.appendChild(el("div", { style: { fontSize: "11px", color: group.color, marginTop: "1px" } }, typeLabel));
            chLeft.appendChild(chInfo);
            ch.appendChild(chLeft);
            if (groupDone) ch.appendChild(el("div", { className: "check-mark" }, "‚úì"));
            card.appendChild(ch);

            // Render exercise inputs
            function renderExerciseInput(ex) {
              var isTimerRunning = state.timerActive && state.timerExId === ex.id;
              var isEditing = state.editingExercise === ex.id;
              var value = todayRecords[ex.id];
              var done = value != null;

              if (done && !isEditing) {
                var row = el("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: isMulti ? "6px 0" : "0" } });
                var left = el("div", { style: { display: "flex", alignItems: "center", gap: "8px" } });
                if (isMulti) left.appendChild(el("span", { style: { fontSize: "12px", color: "#aaa", minWidth: "52px" } }, ex.name));
                left.appendChild(el("span", { style: { fontSize: isMulti ? "18px" : "22px", fontWeight: "800", color: ex.color } },
                  ex.type === "time" ? formatTime(value) : value + ex.unit));
                row.appendChild(left);
                var btns = el("div", { style: { display: "flex", gap: "8px" } });
                btns.appendChild(el("button", { className: isMulti ? "edit-btn-sm" : "edit-btn", onClick: function() { state.editingExercise = ex.id; state.inputValue = String(value); render(); } }, "Á∑®ÈõÜ"));
                btns.appendChild(el("button", { className: isMulti ? "delete-btn-sm" : "delete-btn", onClick: function() { deleteRecord(ex.id); } }, "ÂâäÈô§"));
                row.appendChild(btns);
                return row;
              }

              if (isEditing) {
                var wrap = el("div", { style: { display: "flex", flexDirection: "column", gap: "10px", padding: isMulti ? "8px 0" : "0" } });
                if (isMulti) wrap.appendChild(el("div", { style: { fontSize: "12px", color: "#aaa", fontWeight: "600" } }, ex.name));

                if (ex.type === "time" && !isTimerRunning) {
                  wrap.appendChild(el("button", {
                    className: "action-btn",
                    style: { background: "linear-gradient(135deg," + ex.color + "," + ex.color + "cc)", padding: "10px" },
                    onClick: function() { handleTimerToggle(ex.id); }
                  }, "‚è± „Çø„Ç§„Éû„ÉºÈñãÂßã"));
                  wrap.appendChild(el("div", { style: { textAlign: "center", color: "#555", fontSize: "12px" } }, "„Åæ„Åü„ÅØ"));
                  var inRow = el("div", { style: { display: "flex", gap: "8px" } });
                  var inp = el("input", { className: "num-input", type: "number", placeholder: "ÁßíÊï∞„ÇíÂÖ•Âäõ", value: state.inputValue,
                    onInput: function(e) { state.inputValue = e.target.value; },
                    onKeydown: function(e) { if (e.key === "Enter") handleInputSubmit(ex.id); }
                  });
                  inRow.appendChild(inp);
                  inRow.appendChild(el("button", { className: "submit-btn", onClick: function() { handleInputSubmit(ex.id); } }, "Ë®òÈå≤"));
                  wrap.appendChild(inRow);
                } else if (isTimerRunning) {
                  var timerDisplay = el("div", { style: { textAlign: "center" } });
                  var timeStr = String(Math.floor(state.timerSeconds/60)).padStart(2,"0") + ":" + String(state.timerSeconds%60).padStart(2,"0");
                  timerDisplay.appendChild(el("div", { style: { fontSize: "48px", fontWeight: "800", fontVariantNumeric: "tabular-nums", color: ex.color, marginBottom: "12px", letterSpacing: "2px" } }, timeStr));
                  timerDisplay.appendChild(el("button", {
                    className: "action-btn",
                    style: { background: "linear-gradient(135deg,#e63946,#ff6b6b)" },
                    onClick: function() { handleTimerToggle(ex.id); }
                  }, "‚èπ „Çπ„Éà„ÉÉ„ÉóÔºÜË®òÈå≤"));
                  wrap.appendChild(timerDisplay);
                } else {
                  var inRow = el("div", { style: { display: "flex", gap: "8px" } });
                  var inp = el("input", { className: "num-input", type: "number", placeholder: ex.unit + "Êï∞„ÇíÂÖ•Âäõ", value: state.inputValue,
                    onInput: function(e) { state.inputValue = e.target.value; },
                    onKeydown: function(e) { if (e.key === "Enter") handleInputSubmit(ex.id); }
                  });
                  inRow.appendChild(inp);
                  inRow.appendChild(el("button", { className: "submit-btn", onClick: function() { handleInputSubmit(ex.id); } }, "Ë®òÈå≤"));
                  wrap.appendChild(inRow);
                }
                wrap.appendChild(el("button", { className: "cancel-link", onClick: cancelEditing }, "„Ç≠„É£„É≥„Çª„É´"));
                return wrap;
              }
              return null;
            }

            if (isMulti) {
              for (var mi = 0; mi < members.length; mi++) {
                var exEl = renderExerciseInput(members[mi]);
                if (exEl) card.appendChild(exEl);
              }
              if (!groupDone && !anyEditing) {
                var btnsRow = el("div", { style: { display: "flex", gap: "8px" } });
                for (var mi = 0; mi < members.length; mi++) {
                  (function(m) {
                    btnsRow.appendChild(el("button", {
                      className: "action-btn",
                      style: { flex: "1", padding: "10px", fontSize: "14px", background: "linear-gradient(135deg," + m.color + "," + m.color + "aa)" },
                      onClick: function() { state.editingExercise = m.id; render(); }
                    }, m.name + "„ÇíË®òÈå≤"));
                  })(members[mi]);
                }
                card.appendChild(btnsRow);
              }
              if (!anyEditing && groupDone) {
                var unrecorded = [];
                for (var mi = 0; mi < members.length; mi++) { if (todayRecords[members[mi].id] == null) unrecorded.push(members[mi]); }
                if (unrecorded.length > 0) {
                  var addRow = el("div", { style: { display: "flex", gap: "8px", marginTop: "6px" } });
                  for (var ui = 0; ui < unrecorded.length; ui++) {
                    (function(m) {
                      addRow.appendChild(el("button", {
                        className: "add-more-btn",
                        style: { borderColor: m.color + "44", color: m.color },
                        onClick: function() { state.editingExercise = m.id; render(); }
                      }, "+ " + m.name + "„ÇÇË®òÈå≤"));
                    })(unrecorded[ui]);
                  }
                  card.appendChild(addRow);
                }
              }
            } else {
              var ex = members[0];
              var exEl = renderExerciseInput(ex);
              if (exEl) {
                card.appendChild(exEl);
              } else {
                card.appendChild(el("button", {
                  className: "action-btn",
                  style: { background: "linear-gradient(135deg," + ex.color + "," + ex.color + "aa)" },
                  onClick: function() { state.editingExercise = ex.id; render(); }
                }, "Ë®òÈå≤„Åô„Çã"));
              }
            }
            content.appendChild(card);
          })(EXERCISE_GROUPS[gi]);
        }

        // Week dots
        var weekCard = el("div", { className: "card", style: { marginTop: "28px", padding: "16px" } });
        weekCard.appendChild(el("h3", { style: { fontSize: "14px", fontWeight: "700", color: "#888", margin: "0 0 14px", textAlign: "center" } }, "‰ªäÈÄ±„ÅÆÈÅîÊàêÁä∂Ê≥Å"));
        var weekDotsRow = el("div", { className: "week-dots" });
        var weekData = getWeekData();
        for (var wi = 0; wi < weekData.length; wi++) {
          (function(wd) {
            var col = el("div", { style: { display: "flex", flexDirection: "column", alignItems: "center", gap: "4px" } });
            var dots = el("div", { style: { display: "flex", flexDirection: "column", gap: "3px" } });
            for (var dj = 0; dj < EXERCISE_GROUPS.length; dj++) {
              dots.appendChild(el("div", { className: "week-dot", style: { backgroundColor: wd.groupDone[dj] ? EXERCISE_GROUPS[dj].color : "#2a2a3a" } }));
            }
            col.appendChild(dots);
            var dayIsToday = formatDate(wd.date) === formatDate(new Date());
            col.appendChild(el("div", { style: { fontSize: "11px", fontWeight: "600", color: dayIsToday ? "#ff6b35" : "#888" } }, DAYS_JP[wd.date.getDay()]));
            weekDotsRow.appendChild(col);
          })(weekData[wi]);
        }
        weekCard.appendChild(weekDotsRow);
        content.appendChild(weekCard);
      }

      // ===== CHART VIEW =====
      if (state.view === "chart") {
        // Exercise chips
        var chipRow = el("div", { style: { display: "flex", gap: "6px", marginBottom: "16px", flexWrap: "wrap" } });
        for (var ei = 0; ei < EXERCISES.length; ei++) {
          (function(ex) {
            var active = state.chartExercise === ex.id;
            chipRow.appendChild(el("button", {
              className: "chip-btn",
              style: {
                background: active ? ex.color + "22" : "rgba(255,255,255,0.04)",
                borderColor: active ? ex.color + "66" : "rgba(255,255,255,0.08)",
                color: active ? ex.color : "#888"
              },
              onClick: function() { state.chartExercise = ex.id; render(); }
            }, ex.icon + " " + ex.name));
          })(EXERCISES[ei]);
        }
        content.appendChild(chipRow);

        // Period buttons
        var activeEx = findEx(state.chartExercise);
        var periodBar = el("div", { className: "period-bar" });
        var periods = [["week","ÈÄ±Èñì"],["month","ÊúàÈñì"],["year","Âπ¥Èñì"]];
        for (var pi = 0; pi < periods.length; pi++) {
          (function(key, label) {
            var active = state.chartPeriod === key;
            periodBar.appendChild(el("button", {
              className: "period-btn" + (active ? " active" : ""),
              style: { background: active ? activeEx.color : "transparent" },
              onClick: function() { state.chartPeriod = key; render(); }
            }, label));
          })(periods[pi][0], periods[pi][1]);
        }
        content.appendChild(periodBar);

        // Chart card
        var chartCard = el("div", { className: "card", style: { padding: "16px 8px 8px" } });
        var chartHeader = el("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "baseline", padding: "0 8px", marginBottom: "12px" } });
        chartHeader.appendChild(el("div", { style: { fontSize: "16px", fontWeight: "700" } }, activeEx.icon + " " + activeEx.name));
        chartHeader.appendChild(el("div", { style: { fontSize: "12px", color: "#888" } }, activeEx.type === "time" ? "Áßí" : activeEx.unit));
        chartCard.appendChild(chartHeader);

        var canvas = el("canvas", { className: "chart-canvas" });
        chartCard.appendChild(canvas);
        content.appendChild(chartCard);

        // Stats
        var vals = [];
        var rkeys = Object.keys(state.records);
        for (var ri = 0; ri < rkeys.length; ri++) {
          var v = state.records[rkeys[ri]][state.chartExercise];
          if (v != null) vals.push(v);
        }
        var maxV = vals.length > 0 ? Math.max.apply(null, vals) : 0;
        var avgV = vals.length > 0 ? Math.round(vals.reduce(function(a,b){return a+b;},0)/vals.length) : 0;

        var statsRow = el("div", { style: { display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px", marginTop: "12px" } });
        var statsData = [
          { label: "Ë®òÈå≤Êó•Êï∞", value: vals.length + "Êó•" },
          { label: "ÊúÄÈ´òË®òÈå≤", value: vals.length > 0 ? (activeEx.type === "time" ? formatTime(maxV) : maxV + activeEx.unit) : "\u2014" },
          { label: "Âπ≥Âùá", value: vals.length > 0 ? (activeEx.type === "time" ? formatTime(avgV) : avgV + activeEx.unit) : "\u2014" }
        ];
        for (var si = 0; si < statsData.length; si++) {
          var sbox = el("div", { className: "card stat-box", style: { padding: "12px" } });
          sbox.appendChild(el("div", { className: "label" }, statsData[si].label));
          sbox.appendChild(el("div", { className: "value", style: { color: activeEx.color } }, statsData[si].value));
          statsRow.appendChild(sbox);
        }
        content.appendChild(statsRow);

        // Draw chart after DOM is ready
        setTimeout(function() {
          var chartData = getChartData(state.chartExercise, state.chartPeriod);
          if (state.chartPeriod === "month") {
            drawLineChart(canvas, chartData, activeEx.color);
          } else {
            drawBarChart(canvas, chartData, activeEx.color);
          }
        }, 0);
      }

      // ===== HISTORY VIEW =====
      if (state.view === "history") {
        var historyKeys = Object.keys(state.records).sort(function(a,b) { return b.localeCompare(a); }).slice(0, 90);

        if (historyKeys.length === 0) {
          var emptyDiv = el("div", { style: { textAlign: "center", padding: "60px 0" } });
          emptyDiv.appendChild(el("div", { style: { fontSize: "48px", marginBottom: "12px" } }, "\uD83D\uDCDD"));
          emptyDiv.appendChild(el("div", { style: { fontSize: "18px", fontWeight: "700", marginBottom: "6px" } }, "„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"));
          emptyDiv.appendChild(el("div", { style: { fontSize: "14px", color: "#666" } }, "‰ªäÊó•„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜÔºÅ"));
          content.appendChild(emptyDiv);
        } else {
          for (var hi = 0; hi < historyKeys.length; hi++) {
            (function(dateKey) {
              var d = parseLocalDate(dateKey);
              var rec = state.records[dateKey];
              var complete = countCompletedGroups(rec) === TOTAL_GROUPS;

              var hcard = el("div", {
                className: "card history-item" + (complete ? " done" : ""),
                onClick: function() { state.selectedDate = d; state.view = "today"; render(); }
              });

              var hTop = el("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "10px" } });
              hTop.appendChild(el("div", { style: { fontSize: "15px", fontWeight: "700" } }, formatDateJP(d)));
              if (complete) hTop.appendChild(el("span", { className: "complete-badge" }, "COMPLETE"));
              hcard.appendChild(hTop);

              var exerciseRow = el("div", { style: { display: "flex", gap: "10px", flexWrap: "wrap" } });
              for (var ei = 0; ei < EXERCISES.length; ei++) {
                var ex = EXERCISES[ei];
                var val = rec[ex.id];
                if (val != null) {
                  var item = el("div", { style: { display: "flex", alignItems: "center", gap: "4px" } });
                  item.appendChild(el("span", { style: { fontSize: "13px" } }, ex.icon));
                  item.appendChild(el("span", { style: { fontSize: "12px", fontWeight: "600", color: ex.color } },
                    ex.name + ": " + (ex.type === "time" ? formatTime(val) : val + ex.unit)));
                  exerciseRow.appendChild(item);
                }
              }
              for (var gi2 = 0; gi2 < EXERCISE_GROUPS.length; gi2++) {
                var g = EXERCISE_GROUPS[gi2];
                var hasAny = false;
                for (var mi = 0; mi < g.members.length; mi++) { if (rec[g.members[mi]] != null) { hasAny = true; break; } }
                if (!hasAny) {
                  var item = el("div", { style: { display: "flex", alignItems: "center", gap: "4px" } });
                  item.appendChild(el("span", { style: { fontSize: "13px" } }, g.icon));
                  item.appendChild(el("span", { style: { fontSize: "12px", fontWeight: "600", color: "#444" } }, "\u2014"));
                  exerciseRow.appendChild(item);
                }
              }
              hcard.appendChild(exerciseRow);
              content.appendChild(hcard);
            })(historyKeys[hi]);
          }
        }
      }

      app.appendChild(content);
    }

    // ---- Init ----
    function init() {
      try {
        state.records = loadRecords();
        storageSet("_ping", "1");
        var check = storageGet("_ping");
        state.storageOk = !!check;
        storageDel("_ping");
      } catch(e) {
        state.storageOk = false;
      }
      state.loaded = true;
      render();
    }

    // Start app when DOM ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</body>
</html>
